{extend name='admin@main'}

{block name="content"}
<form onsubmit="return false;" id="GoodsForm" data-auto="true" method="post" class='layui-form layui-card' autocomplete="off">

    <div class="layui-card-body" style="padding-left:40px">

        <div class="layui-form-item">
            <p class="help-block">商品规格</p>
            <div ng-repeat="x in specs track by $index" class="margin-bottom-10">
                <div class="goods-spec-box">
                    <span class="text-center goods-spec-title">规格{{ $index+1 }}</span>
                    <input ng-model="x.name" required placeholder="请输入分组">
                    <a class="layui-btn layui-btn-sm layui-btn-primary goods-spec-button layui-bg-gray" ng-if="x.list.length>=5">增 加</a>
                    <a class="layui-btn layui-btn-sm layui-btn-primary goods-spec-button" ng-if="x.list.length<5" ng-click="addSpecVal(x.list)">增 加</a>
                    <a class="layui-btn layui-btn-sm layui-btn-primary goods-spec-button" ng-click="delSpecRow(specs,$index)">删 除</a>
                    <a class="layui-btn layui-btn-sm layui-btn-primary goods-spec-button layui-bg-gray" ng-if="$index<1">上 移</a>
                    <a class="layui-btn layui-btn-sm layui-btn-primary goods-spec-button" ng-if="$index>0" ng-click="upSpecRow(specs,$index)">上 移</a>
                    <a class="layui-btn layui-btn-sm layui-btn-primary goods-spec-button layui-bg-gray" ng-if="$index>=specs.length-1">下 移</a>
                    <a class="layui-btn layui-btn-sm layui-btn-primary goods-spec-button" ng-if="$index<specs.length-1" ng-click="dnSpecRow(specs,$index)">下 移</a>
                </div>
                <div class="inline-block" ng-if="x.list && x.list.length > 0">
                    <label class="goods-spec-box inline-block nowrap" ng-repeat="xx in x.list">
                        <input type="checkbox" ng-model="xx.check">
                        <input type="text" ng-model="xx.name" required placeholder="请输入规格">
                        <a ng-click="x.list=delSpecVal(x.list,$index)" class="layui-icon layui-icon-close font-s12 goods-spec-close"></a>
                    </label>
                </div>
            </div>
            <a ng-if="specs.length<5" class="layui-btn layui-btn-sm layui-btn-primary" ng-click="addSpecRow(specs)">增加分组</a>
            <table class="layui-table">
                <thead>
                <tr>
                    <th ng-repeat="x in specsTreeNava track by $index" ng-bind="x"></th>
                    <th>价格</th>
                    <th>套餐</th>
                </tr>
                </thead>
                <tbody>
                <tr ng-repeat="rows in specsTreeData track by $index">
                    <td ng-if="td.show" rowspan="{{td.rowspan}}" ng-repeat="td in rows">{{td.name}}</td>
                    <td><input name="price" class="layui-input" ng-keyup="setValue(rows[0].key,'price',$event.target.value)" ng-model="rows[0].price"></td>
                    <td><input name="package" class="layui-input" ng-keyup="setValue(rows[0].key,'package',$event.target.value)" ng-model="rows[0].package"></td>
                </tr>
                </tbody>
            </table>
        </div>

        <div class="layui-form-item">
            <p class="help-block">商品规格</p>
            <textarea name="specs" style="height:300px" class="layui-textarea">{{specsTreeData}}</textarea>
            <textarea name="specs" style="height:300px" class="layui-textarea">{{specs}}</textarea>
        </div>

    </div>
</form>

<style>

    .goods-spec-box {
        margin: 0 10px 10px 0;
        position: relative;
        vertical-align: middle;
    }

    .goods-spec-title {
        position: absolute;
        z-index: 2;
        width: 40px;
        height: 28px;
        line-height: 28px;
        background: #2F4056;
        color: #fff
    }

    .goods-spec-close {
        position: absolute;
        right: 8px;
        line-height: 28px;
        z-index: 2;
        display: inline-block
    }

    .goods-spec-button {
        height: 28px;
        line-height: 26px !important;
        margin-top: -3px;
        margin-left: 5px !important;
    }

    .goods-spec-box input {
        z-index: 1;
        width: 120px;
        position: relative;
        border: 1px solid #999;
        padding: 5px 0 5px 45px;
        display: inline-block !important;
    }

    .goods-spec-box input[type=checkbox] {
        z-index: 2;
        width: 40px;
        height: 28px;
        border: none;
        cursor: pointer;
        position: absolute;
        appearance: none;
        -webkit-appearance: none;
    }

    .goods-spec-box input[type=checkbox]:before {
        top: 1px;
        left: 1px;
        width: 40px;
        height: 26px;
        content: ' ';
        position: absolute;
        background: #c9c9c9;
    }

    .goods-spec-box input[type=checkbox]:after {
        top: 1px;
        left: 1px;
        color: #999;
        width: 40px;
        height: 26px;
        content: '\1006';
        font-size: 16px;
        line-height: 26px;
        position: absolute;
        text-align: center;
        font-family: 'layui-icon';
    }

    .goods-spec-box input[type=checkbox]:checked:after {
        color: #fff;
        content: '\e605';
        background: #00B83F;
    }
</style>

{/block}

{block name='script'}
<script>

    require(['ckeditor', 'angular'], function () {
        // window.form.render();
        // window.createEditor('[name="goods_content"]', {height: 500});
        let app = angular.module("GoodsForm", []).run(callback);
        angular.bootstrap(document.getElementById(app.name), [app.name]);

        function callback($rootScope) {
            let defaultValues = {};
            $rootScope.getValue = function (key, type) {
                return (defaultValues[key] || {type: '0.0'})[type] || '0.00';
            };
            $rootScope.setValue = function (key, type, value) {
                defaultValues[key] || (defaultValues[key] = {});
                defaultValues[key][type] = value;
            };
            // 生成交叉表格数据
            $rootScope.specsTreeData = [];
            $rootScope.specsTreeNava = [];
            // 当前商品规格发生变化时重新计算规格列表
            $rootScope.$watch('specs', function () {
                let list = [], nava = [], sarr = [[]];
                let data = angular.fromJson(angular.toJson($rootScope.specs));
                // 过滤无效记录
                for (let o of data) {
                    let tmp = [];
                    for (let x of o.list) (x.check && x.name.length > 0) && tmp.push(x);
                    if (tmp.length > 0) {
                        for (let x of tmp) (x.group = o.name, x.rowspan = 1, x.show = true)
                        list.push(tmp), nava.push(o.name);
                    }
                    $rootScope.specsTreeNava = nava;
                }
                // 表格交叉
                for (let i in list) {
                    let tarr = [];
                    for (let j in sarr) for (let k in list[i]) tarr.push(sarr[j].concat(list[i][k]));
                    sarr = tarr;
                }
                // 表格合并
                list = angular.fromJson(angular.toJson(sarr));
                for (let row in list) {
                    let key = [];
                    for (let td in list[row]) key.push(list[row][td].group + '=>' + list[row][td].name);
                    for (let td in list[row]) {
                        list[row][0].key = key.join(';;');
                        list[row][0].price = $rootScope.getValue(list[row][0].key, 'price');
                        list[row][0].package = $rootScope.getValue(list[row][0].key, 'package');
                        for (let dow = 1 + parseInt(row); dow < list.length; dow++)
                            if (list[row][td].name === list[dow][td].name) (list[row][td].rowspan++, list[dow][td].show = false);
                            else break;
                    }
                }
                $rootScope.specsTreeData = list;
            }, true);
            // 增加整行规格分组
            $rootScope.addSpecRow = function (data) {
                data.push({name: '', list: []})
            };
            $rootScope.dnSpecRow = function (data, $index) {
                let tmp = [], cur = data[$index];
                if ($index > data.length - 2) return false;
                for (let i in data) {
                    (parseInt(i) !== parseInt($index)) && tmp.push(data[i]);
                    (parseInt(i) === parseInt($index) + 1) && tmp.push(cur);
                }
                return $rootScope.specs = tmp;
            };
            $rootScope.upSpecRow = function (data, $index) {
                let tmp = [], cur = data[$index];
                if ($index < 1) return false;
                for (let i in data) {
                    (parseInt(i) === parseInt($index) - 1) && tmp.push(cur);
                    (parseInt(i) !== parseInt($index)) && tmp.push(data[i]);
                }
                return $rootScope.specs = tmp;
            };
            // 移除整行规格分组
            $rootScope.delSpecRow = function (data, $index) {
                let temp = [];
                for (let i in data) if (parseInt(i) !== parseInt($index)) temp.push(data[i]);
                return $rootScope.specs = temp;
            };
            // 增加分组的属性
            $rootScope.addSpecVal = function (list) {
                list.push({name: '', check: false});
            };
            // 移除分组的属性
            $rootScope.delSpecVal = function (data, $index) {
                let temp = [];
                for (let i in data) if (parseInt(i) !== parseInt($index)) temp.push(data[i]);
                return data = temp;
            };

            $rootScope.specs = [
                {
                    name: '颜色',
                    list: [
                        {name: '红色', check: true},
                        {name: '蓝色', check: true},
                        {name: '黑色', check: true},
                    ]
                },
                {
                    name: '尺寸1',
                    list: [
                        {name: '小', check: true},
                        {name: '中', check: true},
                    ]
                }, {
                    name: '尺寸2',
                    list: [
                        {name: '小', check: true},
                        {name: '中', check: true},
                    ]
                }, {
                    name: '尺寸',
                    list: [
                        {name: '小', check: true},
                        {name: '中', check: true},
                    ]
                }, {
                    name: '尺寸',
                    list: [
                        {name: '小', check: true},
                        {name: '中', check: true},
                    ]
                },
                {
                    name: '套餐',
                    list: [
                        {name: '一', check: true},
                        {name: '二', check: true},
                    ]
                }
            ];
        }

    })
</script>
{/block}